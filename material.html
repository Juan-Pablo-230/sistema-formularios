<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Material</title>
    <link rel="stylesheet" href="/css/formularios.css">
</head>
<body>
    <div class="container">
        <h1>üìö Solicitar Material de Clases</h1>
        
        <div class="back-btn-container">
            <button onclick="window.location.href='/index.html'" class="back-btn">‚Üê Volver al Men√∫ Principal</button>
        </div>
        
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <form id="materialForm">
            <div class="form-group">
                <label for="claseSeleccionada">Seleccionar Clase *</label>
                <select id="claseSeleccionada" name="clase" required>
                    <option value="">Seleccione una clase</option>
                    <option value="Fundamentos de la Redacci√≥n en la Gesti√≥n">Fundamentos de la Redacci√≥n en la Gesti√≥n</option>
                    <option value="Proceso de admisi√≥n">Proceso de admisi√≥n</option>
                    <!-- Puedes a√±adir m√°s opciones aqu√≠ siempre que quieras -->
                </select>
            </div>

            <div class="form-group">
                <label for="emailUsuario">Correo Electr√≥nico</label>
                <input type="email" id="emailUsuario" name="email" required>
            </div>

            <button type="submit" class="submit-btn">üìß Solicitar Material</button>
        </form>
        
        <div id="misSolicitudes" style="margin-top: 40px; display: none;">
            <h2 style="text-align: center; margin-bottom: 20px;">Mis Solicitudes</h2>
            <table class="inscripciones-table" id="tablaMisSolicitudes">
                <thead>
                    <tr>
                        <th>Clase</th>
                        <th>Fecha Solicitud</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llenar√° din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Primero cargar auth.js y formularios.js para tener las funciones de autenticaci√≥n -->
    <script src="/js/auth.js"></script>
    <script src="/js/formularios.js"></script>
    
    <!-- SCRIPT DE CONTROL DE DISPONIBILIDAD - PRIMERO -->
    <script>
    // Configuraci√≥n de disponibilidad de las clases
    const REGLAS_DISPONIBILIDAD = {
        "Fundamentos de la Redacci√≥n en la Gesti√≥n": {
            disponible: {
                desde: "2025-11-16T00:00:00", // 16 de Noviembre, 00:00hs
                hasta: "2025-12-18T23:59:00"   // 18 de Diciembre, 23:59hs
            }
        },
        "Proceso de admisi√≥n": {
            disponible: {
                desde: "2025-11-16T00:00:00", // 16 de Noviembre, 00:00hs
                hasta: "2025-12-19T23:59:00"   // 19 de Diciembre, 23:59hs
            }
        }
    };

    class ControladorDisponibilidadClases {
        constructor() {
            this.selectElement = document.getElementById('claseSeleccionada');
            this.intervaloVerificacion = null;
            this.opcionesOriginales = new Map();
            this.init();
        }

        init() {
            console.log('üïê [Disponibilidad] Inicializando controlador...');
            
            // Cargar opciones inmediatamente
            this.cargarOpcionesOriginales();
            this.actualizarOpciones();
            this.iniciarVerificacionPeriodica();
        }

        cargarOpcionesOriginales() {
            console.log('üìã [Disponibilidad] Cargando opciones originales...');
            
            for (let i = 0; i < this.selectElement.options.length; i++) {
                const option = this.selectElement.options[i];
                const value = option.value;
                
                if (value) {
                    this.opcionesOriginales.set(value, {
                        text: option.textContent,
                        value: value
                    });
                    console.log(`üìù [Disponibilidad] Opci√≥n guardada: "${value}"`);
                }
            }
        }

        estaDisponible(value) {
            const regla = REGLAS_DISPONIBILIDAD[value];
            
            // Si no hay regla, siempre disponible
            if (!regla) {
                return true;
            }
            
            try {
                const ahora = new Date();
                const desde = new Date(regla.disponible.desde);
                const hasta = new Date(regla.disponible.hasta);
                
                if (isNaN(desde.getTime()) || isNaN(hasta.getTime())) {
                    return true;
                }
                
                const disponible = ahora >= desde && ahora <= hasta;
                console.log(`üìÖ [Disponibilidad] "${value}": ${disponible ? 'DISPONIBLE' : 'NO disponible'} (${ahora.toLocaleString('es-AR')})`);
                
                return disponible;
            } catch (error) {
                console.error(`‚ùå [Disponibilidad] Error con "${value}":`, error);
                return true;
            }
        }

        actualizarOpciones() {
            console.log('üîÑ [Disponibilidad] Actualizando opciones...');
            const ahora = new Date();
            console.log(`üïê [Disponibilidad] Hora actual: ${ahora.toLocaleString('es-AR')}`);
            
            const valorSeleccionado = this.selectElement.value;
            let opcionSeleccionadaDisponible = false;
            
            // Limpiar todas las opciones excepto el placeholder
            while (this.selectElement.options.length > 1) {
                this.selectElement.remove(1);
            }
            
            // A√±adir opciones seg√∫n disponibilidad
            let opcionesVisibles = 0;
            this.opcionesOriginales.forEach((opcionOriginal, value) => {
                if (this.estaDisponible(value)) {
                    const nuevaOpcion = document.createElement('option');
                    nuevaOpcion.value = value;
                    nuevaOpcion.textContent = opcionOriginal.text;
                    this.selectElement.appendChild(nuevaOpcion);
                    
                    if (valorSeleccionado === value) {
                        nuevaOpcion.selected = true;
                        opcionSeleccionadaDisponible = true;
                    }
                    
                    opcionesVisibles++;
                    console.log(`‚ûï [Disponibilidad] Mostrando: "${value}"`);
                } else {
                    console.log(`‚ûñ [Disponibilidad] Ocultando: "${value}"`);
                }
            });
            
            if (!opcionSeleccionadaDisponible && valorSeleccionado) {
                this.selectElement.value = '';
            }
            
            console.log(`üìä [Disponibilidad] ${opcionesVisibles}/${this.opcionesOriginales.size} opciones visibles`);
        }

        iniciarVerificacionPeriodica() {
            // Verificar cada 30 segundos
            this.intervaloVerificacion = setInterval(() => {
                this.actualizarOpciones();
            }, 30000);
            
            // Verificar en el pr√≥ximo cambio de minuto
            const ahora = new Date();
            const segundosParaProximoMinuto = 60 - ahora.getSeconds();
            
            setTimeout(() => {
                this.actualizarOpciones();
                setInterval(() => this.actualizarOpciones(), 60000);
            }, segundosParaProximoMinuto * 1000);
        }
    }
    </script>

    <!-- SCRIPT PRINCIPAL DE MATERIAL CON INTEGRACI√ìN DE AUTENTICACI√ìN -->
    <script>
    class MaterialUsuario {
        constructor() {
            this.solicitudes = [];
            this.apiBaseUrl = window.location.origin + '/api';
            console.log('üöÄ [Material] URL API:', this.apiBaseUrl);
            
            // Inicializar despu√©s de asegurar que authSystem est√° listo
            this.init();
        }

        async init() {
            console.log('üöÄ [Material] Inicializando sistema con autenticaci√≥n...');
            
            // Esperar a que el sistema de autenticaci√≥n est√© listo
            try {
                await waitForAuthSystem();
                console.log('‚úÖ [Material] authSystem listo para usar');
            } catch (error) {
                console.error('‚ùå [Material] Error esperando por authSystem:', error);
                this.mostrarError('Error al cargar el sistema de autenticaci√≥n. Por favor, recargue la p√°gina.');
                return;
            }
            
            // Verificar autenticaci√≥n
            if (!isLoggedInSafe()) {
                try {
                    console.log('üîê [Material] Usuario no logueado, mostrando modal de login...');
                    await authSystem.showLoginModal();
                    console.log('‚úÖ [Material] Usuario autenticado:', getCurrentUserSafe());
                } catch (error) {
                    console.log('‚ùå [Material] Usuario cancel√≥ el login');
                    window.location.href = '../index.html';
                    return;
                }
            }
            
            // Ahora configurar UI con usuario autenticado
            this.configurarUI();
            await this.probarConexion();
            await this.cargarMisSolicitudes();
            
            // Inicializar controlador de disponibilidad
            window.controladorClases = new ControladorDisponibilidadClases();
            window.REGLAS_DISPONIBILIDAD = REGLAS_DISPONIBILIDAD;
            
            // Forzar una actualizaci√≥n del controlador despu√©s de que todo est√© listo
            if (window.controladorClases) {
                setTimeout(() => {
                    console.log('üîß [Material] Forzando actualizaci√≥n de disponibilidad...');
                    window.controladorClases.actualizarOpciones();
                }, 500);
            }
            
            // Agregar bot√≥n de logout
            this.agregarBotonLogout();
            
            console.log('‚úÖ [Material] Sistema inicializado correctamente');
        }

        async probarConexion() {
            try {
                console.log('üîç [Material] Probando conexi√≥n con API...');
                const response = await fetch(`${this.apiBaseUrl}/test/simple`);
                const text = await response.text();
                
                try {
                    const result = JSON.parse(text);
                    console.log('‚úÖ [Material] Conexi√≥n API exitosa:', result);
                    return true;
                } catch (e) {
                    console.error('‚ùå [Material] No es JSON v√°lido:', text.substring(0, 200));
                    return false;
                }
            } catch (error) {
                console.error('‚ùå [Material] Error probando conexi√≥n API:', error);
                this.mostrarError('Error de conexi√≥n con el servidor');
                return false;
            }
        }

        configurarUI() {
            const usuario = getCurrentUserSafe();
            console.log('üë§ [Material] Usuario actual:', usuario);
            
            if (usuario && usuario.email) {
                // AUTOM√ÅTICO: Completar email del usuario logueado
                document.getElementById('emailUsuario').value = usuario.email;
                console.log('‚úÖ [Material] Email autocompletado:', usuario.email);
            } else {
                this.mostrarError('No se pudo obtener informaci√≥n del usuario');
                return;
            }

            // Configurar env√≠o del formulario
            document.getElementById('materialForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.enviarSolicitud();
            });
            
            // Verificar estado actual del select
            console.log('üîç [Material] Estado inicial del select:');
            const select = document.getElementById('claseSeleccionada');
            for (let i = 0; i < select.options.length; i++) {
                console.log(`   [${i}] ${select.options[i].value} - ${select.options[i].textContent}`);
            }
            
            // Si es admin, mostrar opciones especiales (opcional)
            if (isAdminSafe()) {
                this.mostrarOpcionesAdmin();
            }
        }

        agregarBotonLogout() {
            const backBtnContainer = document.querySelector('.back-btn-container');
            if (backBtnContainer && isLoggedInSafe()) {
                const logoutBtn = document.createElement('button');
                logoutBtn.textContent = 'Cerrar Sesi√≥n';
                logoutBtn.className = 'back-btn logout-btn';
                logoutBtn.onclick = function() {
                    if (authSystemReady && authSystem && typeof authSystem.logout === 'function') {
                        authSystem.logout();
                    }
                    window.location.reload();
                };
                backBtnContainer.appendChild(logoutBtn);
            }
        }

        mostrarOpcionesAdmin() {
            const backBtnContainer = document.querySelector('.back-btn-container');
            
            if (backBtnContainer && isLoggedInSafe() && isAdminSafe()) {
                // Limpiar botones existentes (excepto el primero)
                const existingButtons = backBtnContainer.querySelectorAll('button');
                for (let i = 1; i < existingButtons.length; i++) {
                    existingButtons[i].remove();
                }
                
                // Agregar bot√≥n de panel de administraci√≥n
                const adminBtn = document.createElement('button');
                adminBtn.textContent = 'üìä Ir al Panel de Administraci√≥n';
                adminBtn.className = 'back-btn admin-panel-btn';
                adminBtn.onclick = function() {
                    window.location.href = '/admin/dashboard.html';
                };
                backBtnContainer.appendChild(adminBtn);
                
                // Agregar bot√≥n de logout
                const logoutBtn = document.createElement('button');
                logoutBtn.textContent = 'Cerrar Sesi√≥n';
                logoutBtn.className = 'back-btn logout-btn';
                logoutBtn.onclick = function() {
                    if (authSystemReady && authSystem && typeof authSystem.logout === 'function') {
                        authSystem.logout();
                    }
                    window.location.reload();
                };
                backBtnContainer.appendChild(logoutBtn);
                
                // Agregar info de admin
                const adminInfo = document.createElement('div');
                adminInfo.className = 'admin-info';
                adminInfo.innerHTML = `
                    <span style="color: #667eea; font-weight: bold;">üë§ Modo Administrador - Materiales</span>
                `;
                backBtnContainer.appendChild(adminInfo);
            }
        }

        async cargarMisSolicitudes() {
            try {
                const user = getCurrentUserSafe();
                if (!user || !user._id) {
                    console.error('‚ùå [Material] Usuario no tiene ID');
                    return;
                }

                console.log('üîç [Material] Cargando mis solicitudes para usuario:', user._id);
                
                // Usar la funci√≥n segura para hacer requests
                const result = await makeRequestSafe('/material/solicitudes', null, 'GET');
                
                if (result.success && result.data) {
                    this.solicitudes = result.data;
                    console.log(`üìã [Material] ${this.solicitudes.length} solicitudes encontradas`);
                    this.mostrarMisSolicitudes();
                }
            } catch (error) {
                console.error('‚ùå [Material] Error cargando mis solicitudes:', error);
            }
        }

        mostrarMisSolicitudes() {
            if (this.solicitudes.length === 0) return;

            const container = document.getElementById('misSolicitudes');
            const tbody = document.querySelector('#tablaMisSolicitudes tbody');
            
            container.style.display = 'block';
            tbody.innerHTML = '';

            this.solicitudes.forEach(solicitud => {
                const row = document.createElement('tr');
                const fecha = solicitud.fechaSolicitud ? 
                    new Date(solicitud.fechaSolicitud).toLocaleDateString('es-AR') : 
                    'Fecha no disponible';
                
                row.innerHTML = `
                    <td>${solicitud.clase || 'N/A'}</td>
                    <td>${fecha}</td>
                    <td><span style="color: green;">‚úì Solicitado</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        async enviarSolicitud() {
            const clase = document.getElementById('claseSeleccionada').value;
            const email = document.getElementById('emailUsuario').value;

            if (!clase) {
                this.mostrarError('Por favor, seleccione una clase');
                return;
            }

            // Verificar si la clase est√° disponible
            if (window.controladorClases && !window.controladorClases.estaDisponible(clase)) {
                this.mostrarError('Esta clase no est√° disponible en este momento');
                return;
            }

            if (this.solicitudes.some(s => s.clase === clase)) {
                this.mostrarError('Ya ha solicitado material para esta clase');
                return;
            }

            try {
                const user = getCurrentUserSafe();
                if (!user || !user._id) {
                    this.mostrarError('Error: Usuario no autenticado correctamente');
                    return;
                }

                const solicitudData = {
                    clase: clase,
                    email: email
                };

                console.log('üì§ [Material] Enviando solicitud:', solicitudData);
                
                // Usar la funci√≥n segura para hacer requests
                const result = await makeRequestSafe('/material/solicitudes', solicitudData);
                
                console.log('‚úÖ [Material] Resultado del servidor:', result);

                if (result.success) {
                    this.mostrarExito('‚úÖ Solicitud enviada correctamente');
                    document.getElementById('claseSeleccionada').value = '';
                    await this.cargarMisSolicitudes();
                } else {
                    this.mostrarError(result.message || 'Error al enviar la solicitud');
                }
            } catch (error) {
                console.error('‚ùå [Material] Error enviando solicitud:', error);
                this.mostrarError('Error: ' + error.message);
            }
        }

        mostrarExito(mensaje) {
            this.mostrarMensaje(mensaje, 'success');
        }

        mostrarError(mensaje) {
            this.mostrarMensaje(mensaje, 'error');
        }

        mostrarMensaje(mensaje, tipo) {
            const mensajeDiv = document.getElementById('statusMessage');
            mensajeDiv.textContent = mensaje;
            mensajeDiv.className = `status-message ${tipo}`;
            mensajeDiv.style.display = 'block';

            setTimeout(() => {
                mensajeDiv.style.display = 'none';
            }, 5000);
        }
    }

    // Inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ [Material] DOM cargado, inicializando MaterialUsuario...');
        // Peque√±o delay para asegurar que los scripts se carguen
        setTimeout(() => {
            new MaterialUsuario();
        }, 100);
    });
    </script>
</body>
</html>