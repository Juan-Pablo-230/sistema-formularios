<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Material</title>
    <link rel="stylesheet" href="/css/formularios.css">
</head>
<body>
    <div class="container">
        <h1>üìö Solicitar Material de Clases</h1>
        
        <div class="back-btn-container">
            <button onclick="window.location.href='/index.html'" class="back-btn">‚Üê Volver al Men√∫ Principal</button>
            <button id="logoutBtn" class="back-btn logout-btn">üö™ Cerrar Sesi√≥n</button>
        </div>
        
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <form id="materialForm">
            <div class="form-group" id="material">
                <label for="claseSeleccionada">Seleccionar Clase *</label>
                <select id="claseSeleccionada" name="clase" required>
                    <option value="">Seleccione una clase</option>
                    <option value="Fundamentos de la Redacci√≥n en la Gesti√≥n">Fundamentos de la Redacci√≥n en la Gesti√≥n</option>
                    <option value="Proceso de admisi√≥n">Proceso de admisi√≥n</option>
                    <!-- Puedes a√±adir m√°s opciones aqu√≠ siempre que quieras -->
                </select>
            </div>

            <div class="form-group" id="material">
                <label for="emailUsuario">Correo Electr√≥nico</label>
                <input type="email" id="emailUsuario" name="email">
            </div>

            <button type="submit" class="submit-btn">üìß Solicitar Material</button>
        </form>
        
        <div id="misSolicitudes" style="margin-top: 40px; display: none;">
            <h2 style="text-align: center; margin-bottom: 20px;">Mis Solicitudes</h2>
            <table class="inscripciones-table" id="tablaMisSolicitudes">
                <thead>
                    <tr>
                        <th>Clase</th>
                        <th>Fecha Solicitud</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llenar√° din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    
    <!-- SCRIPT DE CONTROL DE DISPONIBILIDAD - PRIMERO -->
    <script>
    // Configuraci√≥n de disponibilidad de las clases
    const REGLAS_DISPONIBILIDAD = {
        "Fundamentos de la Redacci√≥n en la Gesti√≥n": {
            disponible: {
                desde: "2025-11-15T00:00:00", // 15 de Noviembre, 00:00hs
                hasta: "2025-12-18T23:59:00"   // 18 de Diciembre, 23:59hs
            }
        },
        "Proceso de admisi√≥n": {
            disponible: {
                desde: "2025-11-16T00:00:00", // 16 de Noviembre, 00:00hs
                hasta: "2025-12-19T23:59:00"   // 19 de Diciembre, 23:59hs
            }
        }
    };

    class ControladorDisponibilidadClases {
        constructor() {
            this.selectElement = document.getElementById('claseSeleccionada');
            this.intervaloVerificacion = null;
            this.opcionesOriginales = new Map();
            this.init();
        }

        init() {
            console.log('üïê [Disponibilidad] Inicializando controlador...');
            
            // Cargar opciones inmediatamente
            this.cargarOpcionesOriginales();
            this.actualizarOpciones();
            this.iniciarVerificacionPeriodica();
        }

        cargarOpcionesOriginales() {
            console.log('üìã [Disponibilidad] Cargando opciones originales...');
            
            for (let i = 0; i < this.selectElement.options.length; i++) {
                const option = this.selectElement.options[i];
                const value = option.value;
                
                if (value) {
                    this.opcionesOriginales.set(value, {
                        text: option.textContent,
                        value: value
                    });
                    console.log(`üìù [Disponibilidad] Opci√≥n guardada: "${value}"`);
                }
            }
        }

        estaDisponible(value) {
            const regla = REGLAS_DISPONIBILIDAD[value];
            
            // Si no hay regla, siempre disponible
            if (!regla) {
                return true;
            }
            
            try {
                const ahora = new Date();
                const desde = new Date(regla.disponible.desde);
                const hasta = new Date(regla.disponible.hasta);
                
                if (isNaN(desde.getTime()) || isNaN(hasta.getTime())) {
                    return true;
                }
                
                const disponible = ahora >= desde && ahora <= hasta;
                console.log(`üìÖ [Disponibilidad] "${value}": ${disponible ? 'DISPONIBLE' : 'NO disponible'} (${ahora.toLocaleString('es-AR')})`);
                
                return disponible;
            } catch (error) {
                console.error(`‚ùå [Disponibilidad] Error con "${value}":`, error);
                return true;
            }
        }

        actualizarOpciones() {
            console.log('üîÑ [Disponibilidad] Actualizando opciones...');
            const ahora = new Date();
            console.log(`üïê [Disponibilidad] Hora actual: ${ahora.toLocaleString('es-AR')}`);
            
            const valorSeleccionado = this.selectElement.value;
            let opcionSeleccionadaDisponible = false;
            
            // Limpiar todas las opciones excepto el placeholder
            while (this.selectElement.options.length > 1) {
                this.selectElement.remove(1);
            }
            
            // A√±adir opciones seg√∫n disponibilidad
            let opcionesVisibles = 0;
            this.opcionesOriginales.forEach((opcionOriginal, value) => {
                if (this.estaDisponible(value)) {
                    const nuevaOpcion = document.createElement('option');
                    nuevaOpcion.value = value;
                    nuevaOpcion.textContent = opcionOriginal.text;
                    this.selectElement.appendChild(nuevaOpcion);
                    
                    if (valorSeleccionado === value) {
                        nuevaOpcion.selected = true;
                        opcionSeleccionadaDisponible = true;
                    }
                    
                    opcionesVisibles++;
                    console.log(`‚ûï [Disponibilidad] Mostrando: "${value}"`);
                } else {
                    console.log(`‚ûñ [Disponibilidad] Ocultando: "${value}"`);
                }
            });
            
            if (!opcionSeleccionadaDisponible && valorSeleccionado) {
                this.selectElement.value = '';
            }
            
            console.log(`üìä [Disponibilidad] ${opcionesVisibles}/${this.opcionesOriginales.size} opciones visibles`);
        }

        iniciarVerificacionPeriodica() {
            // Verificar cada 30 segundos
            this.intervaloVerificacion = setInterval(() => {
                this.actualizarOpciones();
            }, 30000);
            
            // Verificar en el pr√≥ximo cambio de minuto
            const ahora = new Date();
            const segundosParaProximoMinuto = 60 - ahora.getSeconds();
            
            setTimeout(() => {
                this.actualizarOpciones();
                setInterval(() => this.actualizarOpciones(), 60000);
            }, segundosParaProximoMinuto * 1000);
        }
    }

    // Inicializar inmediatamente cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üìÑ [Disponibilidad] DOM cargado, inicializando controlador...');
        window.controladorClases = new ControladorDisponibilidadClases();
        window.REGLAS_DISPONIBILIDAD = REGLAS_DISPONIBILIDAD;
    });
    </script>

    <!-- SCRIPT PRINCIPAL DE MATERIAL -->
    <script>
    class MaterialUsuario {
        constructor() {
            this.solicitudes = [];
            this.apiBaseUrl = window.location.origin + '/api';
            console.log('üöÄ [Material] URL API:', this.apiBaseUrl);
            
            // Inicializar despu√©s de asegurar que el controlador ya est√° listo
            setTimeout(() => this.init(), 100);
        }

        async init() {
            console.log('üöÄ [Material] Inicializando sistema...');
            
            await this.esperarAuthSystem();
            
            if (!authSystem || !authSystem.isLoggedIn()) {
                console.log('‚ùå [Material] Usuario no logueado');
                this.mostrarError('Debe iniciar sesi√≥n para solicitar material');
                setTimeout(() => window.location.href = '/index.html', 2000);
                return;
            }

            this.configurarUI();
            await this.probarConexion();
            await this.cargarMisSolicitudes();
            
            // Forzar una actualizaci√≥n del controlador despu√©s de que todo est√© listo
            if (window.controladorClases) {
                setTimeout(() => {
                    console.log('üîß [Material] Forzando actualizaci√≥n de disponibilidad...');
                    window.controladorClases.actualizarOpciones();
                }, 500);
            }
        }

        async esperarAuthSystem() {
            return new Promise((resolve) => {
                const check = setInterval(() => {
                    if (typeof authSystem !== 'undefined' && authSystem.getCurrentUser) {
                        clearInterval(check);
                        console.log('‚úÖ [Material] authSystem disponible');
                        resolve();
                    }
                }, 100);
                
                setTimeout(() => {
                    clearInterval(check);
                    console.log('‚ö†Ô∏è [Material] Timeout esperando authSystem');
                    resolve();
                }, 5000);
            });
        }

        async probarConexion() {
            try {
                console.log('üîç [Material] Probando conexi√≥n con API...');
                const response = await fetch(`${this.apiBaseUrl}/test/simple`);
                const text = await response.text();
                
                try {
                    const result = JSON.parse(text);
                    console.log('‚úÖ [Material] Conexi√≥n API exitosa:', result);
                    return true;
                } catch (e) {
                    console.error('‚ùå [Material] No es JSON v√°lido:', text.substring(0, 200));
                    return false;
                }
            } catch (error) {
                console.error('‚ùå [Material] Error probando conexi√≥n API:', error);
                this.mostrarError('Error de conexi√≥n con el servidor');
                return false;
            }
        }

        configurarUI() {
            const usuario = authSystem.getCurrentUser();
            console.log('üë§ [Material] Usuario actual:', usuario);
            
            if (usuario && usuario.email) {
                document.getElementById('emailUsuario').value = usuario.email;
            } else {
                this.mostrarError('No se pudo obtener informaci√≥n del usuario');
                return;
            }

            document.getElementById('logoutBtn').addEventListener('click', () => {
                authSystem.logout();
                window.location.href = '/index.html';
            });

            document.getElementById('materialForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.enviarSolicitud();
            });
            
            // Verificar estado actual del select
            console.log('üîç [Material] Estado inicial del select:');
            const select = document.getElementById('claseSeleccionada');
            for (let i = 0; i < select.options.length; i++) {
                console.log(`   [${i}] ${select.options[i].value} - ${select.options[i].textContent}`);
            }
        }

        async cargarMisSolicitudes() {
            try {
                const user = authSystem.getCurrentUser();
                if (!user || !user._id) {
                    console.error('‚ùå [Material] Usuario no tiene ID');
                    return;
                }

                console.log('üîç [Material] Cargando mis solicitudes para usuario:', user._id);
                
                const response = await fetch(`${this.apiBaseUrl}/material/solicitudes`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'user-id': user._id
                    }
                });

                if (!response.ok) {
                    console.error('‚ùå [Material] Error HTTP:', response.status);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    this.solicitudes = result.data;
                    console.log(`üìã [Material] ${this.solicitudes.length} solicitudes encontradas`);
                    this.mostrarMisSolicitudes();
                }
            } catch (error) {
                console.error('‚ùå [Material] Error cargando mis solicitudes:', error);
            }
        }

        mostrarMisSolicitudes() {
            if (this.solicitudes.length === 0) return;

            const container = document.getElementById('misSolicitudes');
            const tbody = document.querySelector('#tablaMisSolicitudes tbody');
            
            container.style.display = 'block';
            tbody.innerHTML = '';

            this.solicitudes.forEach(solicitud => {
                const row = document.createElement('tr');
                const fecha = solicitud.fechaSolicitud ? 
                    new Date(solicitud.fechaSolicitud).toLocaleDateString('es-AR') : 
                    'Fecha no disponible';
                
                row.innerHTML = `
                    <td>${solicitud.clase || 'N/A'}</td>
                    <td>${fecha}</td>
                    <td><span style="color: green;">‚úì Solicitado</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        async enviarSolicitud() {
            const clase = document.getElementById('claseSeleccionada').value;
            const email = document.getElementById('emailUsuario').value;

            if (!clase) {
                this.mostrarError('Por favor, seleccione una clase');
                return;
            }

            if (this.solicitudes.some(s => s.clase === clase)) {
                this.mostrarError('Ya ha solicitado material para esta clase');
                return;
            }

            try {
                const user = authSystem.getCurrentUser();
                if (!user || !user._id) {
                    this.mostrarError('Error: Usuario no autenticado correctamente');
                    return;
                }

                const solicitudData = {
                    clase: clase,
                    email: email
                };

                console.log('üì§ [Material] Enviando solicitud:', solicitudData);
                
                const result = await authSystem.makeRequest('/material/solicitudes', solicitudData);
                
                console.log('‚úÖ [Material] Resultado del servidor:', result);

                if (result.success) {
                    this.mostrarExito('‚úÖ Solicitud enviada correctamente');
                    document.getElementById('claseSeleccionada').value = '';
                    await this.cargarMisSolicitudes();
                } else {
                    this.mostrarError(result.message || 'Error al enviar la solicitud');
                }
            } catch (error) {
                console.error('‚ùå [Material] Error enviando solicitud:', error);
                this.mostrarError('Error: ' + error.message);
            }
        }

        mostrarExito(mensaje) {
            this.mostrarMensaje(mensaje, 'success');
        }

        mostrarError(mensaje) {
            this.mostrarMensaje(mensaje, 'error');
        }

        mostrarMensaje(mensaje, tipo) {
            const mensajeDiv = document.getElementById('statusMessage');
            mensajeDiv.textContent = mensaje;
            mensajeDiv.className = `status-message ${tipo}`;
            mensajeDiv.style.display = 'block';

            setTimeout(() => {
                mensajeDiv.style.display = 'none';
            }, 5000);
        }
    }

    // Inicializar MaterialUsuario despu√©s de que todo est√© listo
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üìÑ [Material] DOM cargado, inicializando MaterialUsuario...');
        // Peque√±o delay para asegurar que el controlador se inicialice primero
        setTimeout(() => {
            new MaterialUsuario();
        }, 50);
    });
    </script>
</body>
</html>